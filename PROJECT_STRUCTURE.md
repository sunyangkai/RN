# React Native çƒ­æ›´æ–°é¡¹ç›®ç»“æ„è¯´æ˜

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªReact Nativeçƒ­æ›´æ–°é¡¹ç›®ï¼Œæ”¯æŒOTAï¼ˆOver-The-Airï¼‰æ›´æ–°ï¼ŒåŒ…å«å…¨é‡åŒ…å’Œå·®é‡åŒ…ä¸¤ç§æ›´æ–°æ–¹å¼ã€‚é¡¹ç›®é‡‡ç”¨Node.js + Javaçš„æ··åˆæ¶æ„ï¼Œæä¾›å®Œæ•´çš„æ„å»ºã€åˆ†å‘å’Œæ›´æ–°åŠŸèƒ½ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
demo/
â”œâ”€â”€ ğŸ“± React Native App (ä¸»åº”ç”¨)
â”œâ”€â”€ ğŸ”§ build-client/ (æ„å»ºå®¢æˆ·ç«¯)
â”œâ”€â”€ â˜• build-server/ (Javaå·®é‡æœåŠ¡)
â”œâ”€â”€ ğŸ“¦ build/ (æ„å»ºäº§ç‰©)
â””â”€â”€ ğŸ”„ çƒ­æ›´æ–°ç›¸å…³æ–‡ä»¶
```

## ğŸ“ è¯¦ç»†ç›®å½•ç»“æ„

### ğŸ¯ æ ¸å¿ƒç›®å½•

#### `/` (é¡¹ç›®æ ¹ç›®å½•)
```
â”œâ”€â”€ package.json              # ä¸»é¡¹ç›®ä¾èµ–å’Œè„šæœ¬é…ç½®
â”œâ”€â”€ App.tsx                   # React Nativeä¸»ç»„ä»¶
â”œâ”€â”€ index.js                  # RNåº”ç”¨å…¥å£
â”œâ”€â”€ hot-update-manager.js     # çƒ­æ›´æ–°ç®¡ç†å™¨
â”œâ”€â”€ babel.config.js           # Babelé…ç½®
â”œâ”€â”€ metro.config.js           # Metroæ‰“åŒ…é…ç½®
â”œâ”€â”€ tsconfig.json             # TypeScripté…ç½®
â””â”€â”€ PROJECT_STRUCTURE.md      # æœ¬æ–‡æ¡£
```

#### `/src/` (React Nativeæºç )
```
src/
â”œâ”€â”€ assets/                   # é™æ€èµ„æº
â”‚   â”œâ”€â”€ icons/               # å›¾æ ‡æ–‡ä»¶
â”‚   â””â”€â”€ imgs/                # å›¾ç‰‡æ–‡ä»¶
â”œâ”€â”€ components/              # Reactç»„ä»¶
â”œâ”€â”€ screens/                 # é¡µé¢ç»„ä»¶
â”œâ”€â”€ services/                # ä¸šåŠ¡æœåŠ¡
â”œâ”€â”€ config/
â”‚   â””â”€â”€ update-config.js     # çƒ­æ›´æ–°é…ç½®
â”œâ”€â”€ bridge/                  # åŸç”Ÿæ¡¥æ¥
â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â””â”€â”€ types/                   # TypeScriptç±»å‹å®šä¹‰
```

#### `/build-client/` (æ„å»ºå®¢æˆ·ç«¯ - æ‰å¹³åŒ–æ¶æ„)
```
build-client/
â”œâ”€â”€ index.js                 # å‘½ä»¤è¡Œå…¥å£
â”œâ”€â”€ build.js                 # æ ¸å¿ƒæ„å»ºé€»è¾‘
â”œâ”€â”€ config.js                # æ„å»ºé…ç½® (åŠ¨æ€IP)
â”œâ”€â”€ file-utils.js            # æ–‡ä»¶æ“ä½œå·¥å…·
â”œâ”€â”€ hash-utils.js            # å“ˆå¸Œè®¡ç®—å·¥å…·
â”œâ”€â”€ diff-service.js          # Java diffæœåŠ¡è°ƒç”¨å™¨
â”œâ”€â”€ static-server.js         # Koaé™æ€èµ„æºæœåŠ¡å™¨
â””â”€â”€ start-server.js          # ç‹¬ç«‹æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
```

#### `/build-server/` (Javaå·®é‡æœåŠ¡)
```
build-server/
â”œâ”€â”€ pom.xml                  # Mavené…ç½®
â”œâ”€â”€ src/main/java/com/demo/
â”‚   â”œâ”€â”€ DiffService.java     # å”¯ä¸€Javaæ–‡ä»¶ - å‘½ä»¤è¡Œdiffå·¥å…·
â”‚   â””â”€â”€ JsonBuilder.java     # JSONæ„å»ºå·¥å…·
â””â”€â”€ target/
    â””â”€â”€ diff-service-1.0.0.jar # å¯æ‰§è¡ŒJARæ–‡ä»¶
```

#### `/build/` (æ„å»ºäº§ç‰© - Gitå¿½ç•¥)
```
build/
â”œâ”€â”€ manifest.json            # çƒ­æ›´æ–°æ¸…å•æ–‡ä»¶
â”œâ”€â”€ bundles/                 # ç‰ˆæœ¬åŒ–Bundleæ–‡ä»¶
â”‚   â”œâ”€â”€ 0.0.42/
â”‚   â”œâ”€â”€ 0.0.43/
â”‚   â””â”€â”€ ...                  # æ¯ä¸ªç‰ˆæœ¬ä¸€ä¸ªç›®å½•
â”œâ”€â”€ patches/                 # å·®é‡è¡¥ä¸æ–‡ä»¶
â”‚   â”œâ”€â”€ 0.0.42-to-0.0.43.patch
â”‚   â””â”€â”€ ...
â””â”€â”€ assets/                  # é™æ€èµ„æºæ–‡ä»¶
```

#### `/android/` (Androidé¡¹ç›®)
```
android/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ src/main/java/com/demo/
â”‚   â”‚   â”œâ”€â”€ MainActivity.kt         # ä¸»Activity
â”‚   â”‚   â”œâ”€â”€ PatchApplierModule.kt   # è¡¥ä¸åº”ç”¨æ¨¡å—
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ src/main/assets/
â”‚       â””â”€â”€ index.android.bundle    # æ‰“åŒ…åˆ°APKçš„bundle
â””â”€â”€ build.gradle             # Androidæ„å»ºé…ç½®
```

## ğŸ”§ å…³é”®æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒä¸šåŠ¡æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `hot-update-manager.js` | çƒ­æ›´æ–°æ ¸å¿ƒé€»è¾‘ | æ£€æŸ¥æ›´æ–°ã€ä¸‹è½½è¡¥ä¸ã€åº”ç”¨æ›´æ–° |
| `src/config/update-config.js` | çƒ­æ›´æ–°é…ç½® | æœåŠ¡å™¨åœ°å€ã€APIè·¯å¾„é…ç½® |

### æ„å»ºç³»ç»Ÿæ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `build-client/build.js` | æ ¸å¿ƒæ„å»ºé€»è¾‘ | Bundleæ„å»ºã€è¡¥ä¸ç”Ÿæˆã€manifestç®¡ç† |
| `build-client/config.js` | æ„å»ºé…ç½® | åŠ¨æ€IPè·å–ã€è·¯å¾„é…ç½® |
| `build-client/static-server.js` | é™æ€èµ„æºæœåŠ¡å™¨ | KoaæœåŠ¡å™¨ï¼Œæä¾›manifestã€bundleã€patch |

### JavaæœåŠ¡æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `build-server/src/main/java/com/demo/DiffService.java` | å·®é‡ç®—æ³• | å‘½ä»¤è¡Œdiffå·¥å…·ï¼Œç”Ÿæˆunified diffè¡¥ä¸ |
| `build-server/target/diff-service-1.0.0.jar` | å¯æ‰§è¡ŒJAR | Node.jsç›´æ¥è°ƒç”¨çš„å·®é‡æœåŠ¡ |

### äº§ç‰©æ–‡ä»¶

| æ–‡ä»¶/ç›®å½• | ç”¨é€” | è¯´æ˜ |
|-----------|------|------|
| `build/manifest.json` | æ›´æ–°æ¸…å• | åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€ä¸‹è½½åœ°å€ã€å“ˆå¸ŒéªŒè¯ |
| `build/bundles/` | Bundleå­˜å‚¨ | æŒ‰ç‰ˆæœ¬å·ç»„ç»‡çš„bundleæ–‡ä»¶ |
| `build/patches/` | è¡¥ä¸å­˜å‚¨ | ç‰ˆæœ¬é—´çš„å·®é‡è¡¥ä¸æ–‡ä»¶ |

## ğŸš€ NPM Scripts

### å¼€å‘å‘½ä»¤
```bash
npm install              # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
npm run build-ota        # æ„å»ºOTAå…¨é‡åŒ…
npm run build-ota:patch  # æ„å»ºOTAå·®é‡åŒ…
npm run static-server    # å¯åŠ¨é™æ€èµ„æºæœåŠ¡å™¨
npm run dev-server       # æ„å»º+å¯åŠ¨æœåŠ¡å™¨ï¼ˆä¸€é”®å¼€å‘ï¼‰
```

### React Nativeå‘½ä»¤
```bash
npm run android          # è¿è¡ŒAndroidåº”ç”¨
npm run start           # å¯åŠ¨MetroæœåŠ¡å™¨
npm run build           # æ„å»ºAPKå†…ç½®bundle
```

## ğŸ”„ çƒ­æ›´æ–°å·¥ä½œæµç¨‹

### 1. æ„å»ºé˜¶æ®µ
1. **å…¨é‡åŒ…**: `npm run build-ota`
   - æ‰§è¡ŒReact Native bundleæ‰“åŒ…
   - ç›´æ¥è¾“å‡ºåˆ°`build/bundles/ç‰ˆæœ¬å·/`
   - ç”Ÿæˆå…¨é‡manifest.json

2. **å·®é‡åŒ…**: `npm run build-ota:patch`
   - æ„å»ºæ–°ç‰ˆæœ¬bundleï¼ˆä¸æ›´æ–°manifestï¼‰
   - è°ƒç”¨Java diffæœåŠ¡ç”Ÿæˆè¡¥ä¸
   - åœ¨buildOTAå±‚ç»Ÿä¸€æ›´æ–°manifest

### 2. æœåŠ¡é˜¶æ®µ
- **é™æ€æœåŠ¡å™¨**: åŸºäºKoaçš„HTTPæœåŠ¡å™¨
- **ç«¯å£**: 8040ï¼ˆåŠ¨æ€è·å–æœ¬åœ°IPï¼‰
- **CORS**: æ”¯æŒè·¨åŸŸè®¿é—®
- **è·¯ç”±**: `/health`, `/version`, `/manifest.json`, `/bundles/*`, `/patches/*`

### 3. æ›´æ–°é˜¶æ®µ
- **æ£€æŸ¥**: åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥manifest.json
- **å·®é‡æ›´æ–°**: ä¼˜å…ˆä½¿ç”¨è¡¥ä¸æ–‡ä»¶
- **å®Œæ•´æ›´æ–°**: è¡¥ä¸å¤±è´¥æ—¶å›é€€åˆ°å®Œæ•´ä¸‹è½½
- **åŸå­æ›¿æ¢**: ç¡®ä¿æ›´æ–°è¿‡ç¨‹çš„å®‰å…¨æ€§

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### ç®€æ´æ€§
- **æ‰å¹³åŒ–ç»“æ„**: build-clientæ— å¤šå±‚åµŒå¥—
- **ç»Ÿä¸€ä¾èµ–**: æ‰€æœ‰ä¾èµ–åœ¨ä¸»package.jsonä¸­
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ–‡ä»¶åŠŸèƒ½æ˜ç¡®

### å¯ç»´æŠ¤æ€§
- **èŒè´£åˆ†ç¦»**: æ„å»ºã€æœåŠ¡ã€å·®é‡ç®—æ³•åˆ†ç¦»
- **ç»Ÿä¸€æ¥å£**: createUpdateManifestç»Ÿä¸€å¤„ç†å…¨é‡å’Œå·®é‡
- **åŠ¨æ€é…ç½®**: è‡ªåŠ¨è·å–æœ¬åœ°IPï¼Œé€‚åº”ç½‘ç»œç¯å¢ƒ

### å¼€å‘å‹å¥½
- **ä¸€é”®æ“ä½œ**: dev-serverå‘½ä»¤ä¸€é”®æ„å»º+å¯åŠ¨
- **å®æ—¶è°ƒè¯•**: é™æ€æœåŠ¡å™¨æ”¯æŒæœ¬åœ°å¼€å‘æµ‹è¯•
- **ç‰ˆæœ¬ç®¡ç†**: è‡ªåŠ¨ç‰ˆæœ¬åŒ–å­˜å‚¨ï¼Œä¾¿äºå›æº¯

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **å‰ç«¯**: React Native + TypeScript
- **æ„å»º**: Node.js + Metro
- **æœåŠ¡**: Koa.js (é™æ€èµ„æºæœåŠ¡)
- **å·®é‡**: Java + java-diff-utils
- **å­˜å‚¨**: æ–‡ä»¶ç³»ç»Ÿ + AsyncStorage
- **ç½‘ç»œ**: HTTP + fetch API

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

1. **IPåœ°å€**: ä½¿ç”¨æœ¬åœ°IPè€Œélocalhostï¼Œç¡®ä¿æ¨¡æ‹Ÿå™¨å¯è®¿é—®
2. **ç«¯å£ç®¡ç†**: é»˜è®¤8040ç«¯å£ï¼Œå¯é€šè¿‡å‚æ•°æŒ‡å®šå…¶ä»–ç«¯å£
3. **æ–‡ä»¶æ¸…ç†**: æ„å»ºè¿‡ç¨‹è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
4. **ç‰ˆæœ¬ç®¡ç†**: åŸºäºpackage.jsonè‡ªåŠ¨è·å–ç‰ˆæœ¬å·
5. **è·¯å¾„å®‰å…¨**: é™æ€æœåŠ¡å™¨åŒ…å«è·¯å¾„éå†é˜²æŠ¤

## ğŸ” å®‰å…¨è€ƒè™‘

- **è·¯å¾„éªŒè¯**: é˜²æ­¢ç›®å½•éå†æ”»å‡»
- **å“ˆå¸Œæ ¡éªŒ**: æ‰€æœ‰æ–‡ä»¶ä¼ è¾“éƒ½è¿›è¡ŒSHA-256éªŒè¯
- **åŸå­æ“ä½œ**: æ›´æ–°è¿‡ç¨‹ä½¿ç”¨åŸå­æ€§æ–‡ä»¶æ›¿æ¢
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶